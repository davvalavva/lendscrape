(function(n){var l="1.5.2",t=n.RoyAppKeywordProviderConfig,s=n.RoyAppKeywordProviderMemory=n.RoyAppKeywordProviderMemory||{},h=t.pageReferrer||n.document.referrer,c=t.pageUrl||n.location.href,i=function(n){t&&t.debug&&console&&console.debug&&console.debug(n)},u={providePlugin:function(t){var r=n[n.GoogleAnalyticsObject||"ga"];r&&(i("Providing Google Analytics plugin."),r("provide","RoyAppKeywordProvider",t))},pushToDataLayer:function(t,r,u){var e,f;if(!t||!r||!u){i("Insufficient data for pushing to dataLayer.");return}if(e=n[t],!e||!e.push){i("The specified dataLayer could not be found.");return}f={event:r};u.keyword&&(f["RoyAppKeywordProvider.keyword"]=u.keyword);u.position&&(f["RoyAppKeywordProvider.position"]=u.position);u.database&&(f["RoyAppKeywordProvider.database"]=u.database);u.deliveryId&&(f["RoyAppKeywordProvider.deliveryId"]=u.deliveryId);e.push(f);i("Pushed to dataLayer:");i(f)},getLocation:function(t){var i=n.document.createElement("a");return i.href=t,i.host===""&&(i.href=i.href),i},createCorsRequest:function(n,t){var i=new XMLHttpRequest;return"withCredentials"in i?i.open(n,t,!0):typeof XDomainRequest!="undefined"?(i=new XDomainRequest,i.open(n,t)):i=null,i},isInteger:function(n){return typeof n=="number"&&n%1==0}},v=function(r){var u=t.onKeywordProvided;typeof u=="function"&&r.keyword&&(i("Calling onKeywordProvided callback."),n.setTimeout(function(){u(r)},0))},f=function(r){var f,e;if(t&&t.mode==="dataLayer"){if(i("Attempting keyword delivery via dataLayer."),!t.dataLayer){i("Configuration for dataLayer is missing.");return}if(!t.dataLayer.alwaysPush&&(!r||!r.keyword)){i("No keyword data available.");return}i("Keyword data:");i(r);i("Pushing keyword data to dataLayer.");u.pushToDataLayer(t.dataLayer.name,t.dataLayer.event,r||{});return}i("Attempting keyword delivery via Google Analytics plugin.");r&&r.keyword?(i("Keyword data:"),i(r),f=function(n){if(t&&t.plugin&&t.plugin.customDimension&&t.plugin.customDimension.keyword)if(i("Using custom dimension fields."),t.plugin.customDimension.event){i("Will send a non-interaction event.");var u={eventCategory:"Roy App Keyword Provider",eventAction:"Provided organic keyword",eventLabel:r.keyword,nonInteraction:1};u[t.plugin.customDimension.keyword]=r.keyword;t.plugin.customDimension.position&&r.position&&(u[t.plugin.customDimension.position]=r.position);t.plugin.customDimension.database&&r.database&&(u[t.plugin.customDimension.database]=r.database);n.send("event",u);i("Sent non-interaction event:");i(u)}else i("Setting custom dimension fields directly."),n.set(t.plugin.customDimension.keyword,r.keyword),t.plugin.customDimension.position&&r.position&&n.set(t.plugin.customDimension.position,r.position),t.plugin.customDimension.database&&r.database&&n.set(t.plugin.customDimension.database,r.database);else i("Using standard campaign fields."),n.set("campaignKeyword",r.keyword),r.position&&n.set("campaignContent",r.position),n.set("campaignSource","google"),n.set("campaignMedium","organic"),n.set("campaignName","Roy App Keyword Provider")},f.prototype.ack=function(){if(i("RoyAppKeywordProvider.ack called."),s.ackPerformed){i("Ack already performed, aborting.");return}if(r.deliveryId&&t&&t.accountId&&t.apiUrl){var f=u.createCorsRequest("post",t.apiUrl+"/keyword/ack?version="+encodeURIComponent(l));f&&(f.ontimeout=function(){return},f.onload=function(){s.ackPerformed=!0},f.onerror=function(){return},f.onprogress=function(){return},f.timeout=0,n.setTimeout(function(){f.send(JSON.stringify({accountId:t.accountId,deliveryId:r.deliveryId}));i("Ack request sent.")},0))}},u.providePlugin(f)):(i("No keyword data available - will use NullKeywordProvider."),e=function(){i("NullKeywordProvider constructor called.")},e.prototype.ack=function(){i("NullKeywordProvider.ack called.")},u.providePlugin(e))},e,a,o,r;if(t&&!t.accountId&&(t.accountId=t.apiKey),!t||!t.accountId||!c||!h||!n.JSON){i("Basic data and/or browser features not available, aborting.");f(null);return}if(s&&s.deliveryPerformed){i("Delivery already performed, aborting.");f(null);return}if(e=u.getLocation(h),e.hostname.toLowerCase().indexOf("www.google.")<0||e.pathname!==""&&e.pathname!=="/"&&e.pathname!=="search"&&e.pathname!=="/search"&&e.pathname!=="url"&&e.pathname!=="/url"){i("Referrer does not meet criteria, aborting.");f(null);return}if(a=u.getLocation(c),a.search.match(/(^\?|&)(gclid|utm_.+)=/gi)){i("Landing page url does not meet criteria, aborting.");f(null);return}if(o=t.apiUrl||"//api.royapp.com/kp",o.substring(o.length-1)==="/"&&(o=o.slice(0,-1)),t.apiUrl=o,i("API url: "+t.apiUrl),r=u.createCorsRequest("post",t.apiUrl+"/keyword?version="+encodeURIComponent(l)),!r){i("Unable to create CORS request, aborting.");f(null);return}r.onload=function(){var n=JSON.parse(r.responseText);i("Successfully received a response for the keyword request.");f(n);v(n);s.deliveryPerformed=!0};r.onerror=function(){i("Error during keyword request.");f(null)};r.ontimeout=function(){i("Timeout during keyword request.");f(null)};r.onprogress=function(){return};r.timeout=u.isInteger(t.timeout)&&t.timeout>=0?t.timeout:3e3;i("Timeout set to "+r.timeout+" ms.");n.setTimeout(function(){i("Sending keyword request.");r.send(JSON.stringify({accountId:t.accountId,url:c,referrer:h}))},0)})(window)